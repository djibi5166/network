<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MyBlog | Accueil</title>

        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <script src="app.js" defer></script>

        
        <style>
            body {
                font-family: "Poppins", sans-serif;
                background-color: #f0f2f5;
            }

            /* AUTH STYLES */
            .auth-container {
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }
            .auth-card {
                width: 100%;
                max-width: 400px;
                border: none;
                border-radius: 16px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
                overflow: hidden;
            }
            .auth-header {
                background: #4361ee;
                padding: 30px 20px;
                text-align: center;
                color: white;
            }

            /* NAVBAR */
            .navbar {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                box-shadow: 0 2px 15px rgba(0, 0, 0, 0.04);
            }
            .avatar-circle {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: white;
            }

            /* FEED */
            .blog-card {
                border: none;
                border-radius: 16px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
                margin-bottom: 24px;
                transition: transform 0.2s;
                background: white;
            }
            .blog-card:hover {
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            }
            .blog-media img {
                width: 100%;
                max-height: 500px;
                object-fit: cover;
                border-radius: 12px;
                margin-top: 10px;
            }

            /* UTILS */
            .cursor-pointer {
                cursor: pointer;
            }
            .text-primary-custom {
                color: #4361ee;
            }
            .btn-primary-custom {
                background-color: #4361ee;
                border-color: #4361ee;
                color: white;
            }
            .btn-primary-custom:hover {
                background-color: #3f37c9;
            }
            .otp-input {
			  width: 40px;
			  height: 40px;
			  text-align: center;
			  font-size: 24px;
			  padding: 10px;
			  font-weight: bold;
			  border-radius: 8px;
			  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
		 }
		 
		 dialog {
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 5px;
            max-width: 340px;
            width: 100%;
            transition: all 0.5s ease-in-out;
        }

        /* The dark background behind the modal */
            dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px); /* Effet de flou sympa */
        }
        dialog button {
		    width: auto;       
		    height: auto;      
		    transform: scale(1);
		    font-size: 0.9rem;
		    padding: 8px 16px;
		    
     }
        .dialog-header { font-size: 0.25rem; font-weight: bold; margin-bottom: 10px; }
        .dialog-actions { display: flex; justify-content: flex-end; gap: 5px; margin-top: 10px; }
        </style>
    </head>
    <body>
        <div id="authView" class="auth-container">
            <div class="auth-card bg-white">
                <div class="auth-header">
                    <h3 class="fw-bold mb-0">
                        <i class="fas fa-blog me-2"></i>MyBlog
                    </h3>
                    <p class="small opacity-75 mb-0">Partagez vos histoires</p>
                </div>
                <div class="p-4">
                    <div id="loginForm" class="auth-section">
                        <h5 class="fw-bold mb-3">Connexion</h5>
                        <div class="mb-3">
                            <input
                                id="l_user"
                                class="form-control bg-light border-0 py-2"
                                placeholder="Nom d'utilisateur"
                                value="admin"
                            />
                        </div>
                        <div class="mb-3">
                            <input
                                id="l_pass"
                                type="password"
                                class="form-control bg-light border-0 py-2"
                                placeholder="Mot de passe"
                                value="root"
                            />
                        </div>
                        <div class="text-end mb-3">
                            <a
                                href="#"
                                onclick="switchAuth('forgotStep1')"
                                class="small text-muted text-decoration-none"
                                >Mot de passe oublié ?</a
                            >
                        </div>
                        <button
                            onclick="login()"
                            class="btn btn-primary-custom w-100 rounded-pill py-2 fw-bold"
                        >
                            Se connecter
                        </button>
                        <div class="text-center mt-3">
                            <small class="text-muted"
                                >Pas de compte ?
                                <a
                                    href="#"
                                    onclick="switchAuth('registerForm')"
                                    class="text-primary-custom fw-bold text-decoration-none"
                                    >S'inscrire</a
                                ></small
                            >
                        </div>
                    </div>

                    <div id="registerForm" class="auth-section d-none">
                        <h5 class="fw-bold mb-3">Inscription</h5>
                        <div class="mb-3">
                            <input
                                id="r_user"
                                class="form-control bg-light border-0 py-2"
                                placeholder="Choisir un pseudo"
                            />
                        </div>
                        <div class="mb-3">
                            <input
                                id="r_pass"
                                type="password"
                                class="form-control bg-light border-0 py-2"
                                placeholder="Choisir un mot de passe"
                            />
                        </div>
                        <div class="mb-3">
                            <input
                                id="r_email"
                                type="email"
                                class="form-control bg-light border-0 py-2"
                                placeholder="email here !"
                            />
                        </div>
                        <button
                            onclick="register()"
                            class="btn btn-success w-100 rounded-pill py-2 fw-bold"
                        >
                            S'inscrire
                        </button>
                        <div class="text-center mt-3">
                            <a
                                href="#"
                                onclick="switchAuth('loginForm')"
                                class="small text-muted text-decoration-none"
                                >Retour connexion</a
                            >
                        </div>
                    </div>

                    <div id="forgotStep1" class="auth-section d-none">
                        <h5 class="fw-bold mb-3">Récupération</h5>
                        <p class="small text-muted">
                            Entrez votre pseudo (Mode DEV : Token affiché).
                        </p>
                        <input
                            id="fp_user"
                            class="form-control bg-light border-0 mb-3"
                            placeholder="Votre pseudo"
                        />
                        <button
                            onclick="requestResetToken()"
                            class="btn btn-warning text-white w-100 rounded-pill"
                        >
                            Obtenir Token
                        </button>
                        <div class="text-center mt-2">
                            <a
                                href="#"
                                onclick="switchAuth('loginForm')"
                                class="small text-muted text-decoration-none"
                                >Annuler</a
                            >
                        </div>
                    </div>

                    <div id="forgotStep2" class="auth-section d-none">
                        <div class="alert alert-success small p-2 mb-2">
                            <b id="displayToken" class="user-select-none">...</b>
                        </div>
                        <!--  <input
                            id="fp_token"
                            type="number"
                            class="form-control bg-light border-0 mb-2"
                            placeholder="Collez ici      *****"
                        /> -->
                        
                         <div class="d-flex justify-content-center gap-2 mb-4 mt-4">
   <input type="text" inputmode="numeric" autocomplete="one-time-code" class="otp-input form-control" maxlength="1">
   <input type="text" inputmode="numeric" autocomplete="one-time-code" class="otp-input form-control" maxlength="1">
   <input type="text" inputmode="numeric" autocomplete="one-time-code" class="otp-input form-control" maxlength="1">
   <input type="text" inputmode="numeric" autocomplete="one-time-code" class="otp-input form-control" maxlength="1">
   <input type="text" inputmode="numeric" autocomplete="one-time-code" class="otp-input form-control" maxlength="1">
  </div>
                        
                        <!-- essay -->
                        <input
                            id="fp_new_pass"
                            type="password"
                            class="form-control bg-light border-0 mb-1"
                            placeholder="Nouveau mot de passe *"
                        />

                        
                        <button
                            onclick="doResetPassword()"
                            class="btn btn-primary-custom w-100 rounded-pill"
                        >
                            Valider
                        </button>
                       <div class="text-center mt-2">
                        <a href="#"
                                onclick="switchAuth('forgotStep1')"
                                class="small text-muted text-decoration-none"
                            >Annuler</a
                            >
                           </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="appView" class="d-none min-vh-100 d-flex flex-column">
            <nav class="navbar navbar-expand sticky-top">
                <div class="container" style="max-width: 800px">
                    <a class="navbar-brand fw-bold text-primary-custom" href="#"
                        ><i class="fas fa-blog me-2"></i>MyBlog</a
                    >

                    <div class="d-flex align-items-center gap-2">
                        <a
                            id="btnAdmin"
                            href="admin.html"
                            class="btn btn-sm btn-danger rounded-pill px-3 fw-bold d-none shadow-sm"
                        >
                            <i class="fas fa-shield-alt me-1"></i> Dashboard
                        </a>

                        <div class="dropdown">
                            <button
                                class="btn btn-light rounded-circle shadow-sm"
                                data-bs-toggle="dropdown"
                            >
                                <i class="fas fa-user"></i>
                            </button>
                            <ul
                                class="dropdown-menu dropdown-menu-end border-0 shadow-lg p-2 rounded-3"
                            >
                                <li>
                                    <h6 class="dropdown-header" id="welcomeMsg">
                                        User
                                    </h6>
                                </li>

                                <li>
                                    <a
                                        class="dropdown-item rounded-2"
                                        href="#"
                                        data-bs-toggle="modal"
                                        data-bs-target="#settingsModal"
                                    >
                                        <i
                                            class="fas fa-cog me-2 text-muted"
                                        ></i
                                        >Paramètres
                                    </a>
                                </li>

                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <a
                                        class="dropdown-item rounded-2 text-danger"
                                        href="#"
                                        onclick="logout()"
                                        ><i class="fas fa-sign-out-alt me-2"></i
                                        >Déconnexion</a
                                    >
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
    
    <!-- search containaire -->
    
    <div class="container mt-2 ">
  <div class="row justify-content-center ">
    <div class="col-md-8">
      <div class="input-group">
        <input type="search" class="form-control" placeholder="Search..." aria-label="Search" name="search" id="search">
       
        <button class="btn btn-primary" onclick="searchFilter()" type="button">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>
  </div>
</div>

    
    
    
    <!-- search containaire -->
    
    
    
    
            <div class="flex-grow-1">
                <div class="container py-4" style="max-width: 700px">
                    <div
                        class="blog-card p-3 mb-4 cursor-pointer"
                        data-bs-toggle="modal"
                        data-bs-target="#blogModal"
                        onclick="resetForm()"
                    >
                        <div class="d-flex align-items-center gap-3">
                            <div class="avatar-circle bg-light text-muted">
                                <i class="fas fa-user"></i>
                            </div>
                            <div
                                class="form-control rounded-pill bg-light border-0 text-muted"
                                style="cursor: pointer"
                            >
                                Quoi de neuf aujourd'hui ?
                            </div>
                            <button
                                class="btn btn-primary-custom rounded-circle"
                                style="width: 38px; height: 38px"
                            >
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div id="blogList">
                        <div class="text-center py-5">
                            <div
                                class="spinner-border text-primary-custom"
                                role="status"
                            ></div>
                            <p class="mt-2 text-muted small">Chargement...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="blogModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg rounded-4">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold" id="formTitle">
                            Publication
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="blogId" />
                        <input
                            id="title"
                            class="form-control form-control-lg border-0 px-0 fw-bold mb-2 shadow-none"
                            placeholder="Titre"
                        />
                        <textarea
                            id="desc"
                            class="form-control border-0 px-0 text-secondary shadow-none"
                            rows="4"
                            placeholder="Votre histoire..."
                        ></textarea>

                        <div class="d-flex gap-2 mt-3 overflow-auto pb-2">
                            <label
                                class="btn btn-light text-primary rounded-pill border-0 small"
                                ><i class="fas fa-image me-1"></i> Img
                                <input
                                    type="file"
                                    id="fileImg"
                                    accept="image/*"
                                    hidden
                            /></label>
                            <label
                                class="btn btn-light text-warning rounded-pill border-0 small"
                                ><i class="fas fa-microphone me-1"></i> Aud
                                <input
                                    type="file"
                                    id="fileAudio"
                                    accept="audio/*"
                                    hidden
                            /></label>
                            <label
                                class="btn btn-light text-danger rounded-pill border-0 small"
                                ><i class="fas fa-video me-1"></i> Vid
                                <input
                                    type="file"
                                    id="fileVideo"
                                    accept="video/*"
                                    hidden
                            /></label>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button
                            onclick="saveBlog()"
                            class="btn btn-primary-custom rounded-pill w-100 fw-bold"
                        >
                            Publier
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="settingsModal" tabindex="-1">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content border-0 shadow rounded-4">
                    <div class="modal-header border-0">
                        <h6 class="modal-title fw-bold">Sécurité</h6>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body pt-0">
                        <p class="small text-muted mb-3">
                            Changer le mot de passe
                        </p>
                        <input
                            id="up_old"
                            type="password"
                            class="form-control bg-light border-0 mb-2"
                            placeholder="Actuel"
                        />
                        <input
                            id="up_new"
                            type="password"
                            class="form-control bg-light border-0 mb-3"
                            placeholder="Nouveau"
                        />

                        <button
                            onclick="updatePassword()"
                            class="btn btn-dark w-100 rounded-pill btn-sm"
                        >
                            Valider
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div
                id="liveToast"
                class="toast align-items-center text-white bg-dark border-0 shadow-lg"
            >
                <div class="d-flex">
                    <div class="toast-body" id="toastMsg">...</div>
                    <button
                        type="button"
                        class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"
                    ></button>
                </div>
            </div>
        </div>
<!-- comfirm dialo -->

      <dialog id="confirmDialog">
		    <div class="dialog-header text-danger">
		        <i class="fas fa-exclamation-triangle"></i> Confirmation
		    </div>
		    <div class="dialog-body" id="confirmMessage">
		        Voulez-vous vraiment supprimer cet élément ? Cette action est irréversible.
		    </div>
		    <div class="dialog-actions">
		        <button id="cancelBtn" class="btn btn-secondary">Annuler</button>
		        <button id="confirmBtn" class="btn btn-danger">Confirmer la suppression</button>
		    </div>
     </dialog>
     
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            const API = "http://localhost:8000/";
            let currentUser = null;
            let blogModalInstance, settingsModalInstance;
            
            const confirmDialog = document.getElementById('confirmDialog');
		    const confirmBtn = document.getElementById('confirmBtn');
		    const cancelBtn = document.getElementById('cancelBtn');
		    const confirmMessage = document.getElementById('confirmMessage');
		    
		    let pendingAction = null; // Stocke la fonction à exécuter

    // Fonction générique pour ouvrir le dialog
    function openConfirm(message, actionCallback) {
        confirmMessage.innerText = message || "Voulez-vous vraiment supprimer cet élément ?";
        pendingAction = actionCallback; // On sauvegarde l'action
        confirmDialog.showModal();
    }
            
        // Clic sur "Annuler"
    cancelBtn.addEventListener('click', () => {
        confirmDialog.close();
        pendingAction = null; // On nettoie l'action
    });

    // Clic sur "Confirmer"
    confirmBtn.addEventListener('click', () => {
        if (pendingAction) {
            pendingAction(); // Exécute la suppression
        }
        confirmDialog.close();
    });

    // Fermer si on clique en dehors (sur le backdrop)
    confirmDialog.addEventListener('click', (event) => {
        if (event.target === confirmDialog) {
            confirmDialog.close();
        }
    });
    
    
           let allBlogs = []; // Stockage local des articles

            const el = id => document.getElementById(id);
            const esc = s =>
                s ? String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;") : "";
            const getHeaders = (multi = false) => {
                const h = {
                    Authorization: "Bearer " + localStorage.getItem("token")
                };
                if (!multi) h["Content-Type"] = "application/json";
                return h;
            };

            document.addEventListener("DOMContentLoaded", () => {
                blogModalInstance = new bootstrap.Modal(el("blogModal"));
                settingsModalInstance = new bootstrap.Modal(
                    el("settingsModal")
                );
                 // Ajout de l'écouteur pour la recherche en temps réel
  			  el('search').addEventListener('input', searchFilter);
  			  
                checkAuth();
            });

            function showToast(msg, type = "info") {
                const t = el("liveToast");
                const b = el("toastMsg");
                t.className = `toast align-items-center text-white border-0 shadow-lg bg-${
                    type === "error"
                        ? "danger"
                        : type === "success"
                        ? "success"
                        : "dark"
                }`;
                b.innerText = msg;
                new bootstrap.Toast(t).show();
            }

            // --- DECODAGE JWT ROBUSTE ---
            function parseJwt(token) {
                try {
                    let base64 = token
                        .split(".")[1]
                        .replace(/-/g, "+")
                        .replace(/_/g, "/");
                    const pad = base64.length % 4;
                    if (pad) base64 += new Array(5 - pad).join("=");
                    return JSON.parse(
                        decodeURIComponent(
                            window
                                .atob(base64)
                                .split("")
                                .map(
                                    c =>
                                        "%" +
                                        (
                                            "00" + c.charCodeAt(0).toString(16)
                                        ).slice(-2)
                                )
                                .join("")
                        )
                    );
                } catch (e) {
                    return null;
                }
            }

            function checkAuth() {
                const token = localStorage.getItem("token");
                if (!token) return showAuth();

                const payload = parseJwt(token);
                if (!payload || payload.exp * 1000 < Date.now()) {
                    logout();
                    return;
                }
               
                currentUser = payload;
                showApp();
                verifyTokenWithServer();
            }
            
            function verifyTokenWithServer() {
			    fetch(API + "/api/auth/me.php", {
			        method: "GET",
			        headers: getHeaders()
			    })
			    .then(res => {
			        if (res.status === 401) {
			            // C'est ici que ton bloc 401 est utile !
			            logout();
			            showToast("Session invalide ", "error");
			        }
			    })
			    .catch(err => console.error("Erreur réseau:", err));
			}


            function showAuth() {
                el("authView").classList.remove("d-none");
                el("appView").classList.add("d-none");
            }

            function showApp() {
                el("authView").classList.add("d-none");
                el("appView").classList.remove("d-none");
                el("welcomeMsg").innerText = currentUser.username;

                // AFFICHAGE BOUTON ADMIN
                if (currentUser.role === "admin") {
                    el("btnAdmin").classList.remove("d-none");
                } else {
                    el("btnAdmin").classList.add("d-none");
                }
                loadBlogs();
            }

            function switchAuth(id) {
                document
                    .querySelectorAll(".auth-section")
                    .forEach(d => d.classList.add("d-none"));
                el(id).classList.remove("d-none");
            }
            function login() {
                fetch(API + "/api/auth/login.php", {
                    method: "POST",
                    body: JSON.stringify({
                        username: el("l_user").value,
                        password: el("l_pass").value
                    })
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.token) {
                            localStorage.setItem("token", d.token);
                            checkAuth();
                        } else showToast(d.error || "Erreur login", "error");
                    });
            }
            function logout() {
                localStorage.removeItem("token");
                window.location.reload();
            }
            function register() {
                fetch(API + "/api/auth/register.php", {
                    method: "POST",
                    body: JSON.stringify({
                        username: el("r_user").value,
                        password: el("r_pass").value,
                        email: el("r_email").value
                    })
                })
                    .then(r => r.json())
                    .then((r) => {
                       //alert(r)
                       if(r.status === 'registered'){
                        showToast(r.status,'success');
                        switchAuth("loginForm");
                       }else{
                       	showToast(r.error,'error');
                       }
                    });
            }

            // FORGOT / RESET / UPDATE PASSWORD
            function requestResetToken() {
                const username = el("fp_user").value.trim();

                if (!username) {
                    showToast("Username is required", "error");
                    return;
                }
               
                fetch(API + "/api/auth/forgot_password.php", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ username })
                })
                    .then(response => {
                        /*if (!response.ok) {
                            throw new Error(`HTTP ${response.error}`);
                        }*/
                        localStorage.setItem('resetPass',username)
                        return response.json();
                    })
                    .then(data => {
                        if (data.message) {
                            el("displayToken").innerText = data.message;
                            //el("fp_token").value = "";
                            switchAuth("forgotStep2");
                        } else {
                            showToast(data.error || "Unknown error", "error");
                        }
                    })
                    .catch(err => {
                      //  console.error(err);
                        showToast(err || "Server error. Try again later.", "error");
                    });
            }
            function doResetPassword() {
                fetch(API + "/api/auth/reset_password.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }, // <-- Ajout important
                    body: JSON.stringify({
                        token: checkOTP().trim(),//el("fp_token").value.trim(), // .trim() pour enlever les espaces accidentels
                        password: el("fp_new_pass").value
                    })
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.status === "password_updated") {
                            showToast("Mot de passe modifié !");
                            switchAuth("loginForm");
                            
                        } else {
                            showToast(d.error || "Erreur Inconue", "error");
                        }
                    })
                    .catch(e => showToast("Erreur réseau", "error"));
            }

            function updatePassword() {
                fetch(API + "/api/auth/change_password.php", {
                    method: "POST",
                    headers: getHeaders(),
                    body: JSON.stringify({
                        old: el("up_old").value,
                        new: el("up_new").value
                    })
                })
                    .then(r => {
                    	/*
                    	if (res.status === 401) {
					    localStorage.removeItem("token");
					    switchAuth("login");
					}
                        */
                        
                    	return r.json()})
                    .then(d => {
                        if (d.status === "success") {
                            showToast(d.message||"Mis à jour","success");
                            settingsModalInstance.hide();
                        } else showToast(JSON.stringify(d.error )|| "Erreur", "error");
                    });
            }

            // BLOGS
            function loadBlogs() {
                fetch(API + "/api/blog/read.php")
                    .then(r => r.json())
                    .then(blogs => {
                        allBlogs = blogs;
                        const list = el("blogList");
                        if (!blogs.length) {
                            list.innerHTML = `<div class="text-center text-muted mt-5">Aucun article.</div>`;
                            return;
                        }
                        renderBlogs(allBlogs)
                    });
            }

            function resetForm() {
                el("blogId").value = "";
                el("title").value = "";
                el("desc").value = "";
                el("fileImg").value = "";
                el("fileAudio").value = "";
                el("fileVideo").value = "";
                el("formTitle").innerText = "Publication";
            }
            function saveBlog() {
                const fd = new FormData();
                fd.append("title", el("title").value);
                fd.append("description", el("desc").value);
                if (el("fileImg").files[0])
                    fd.append("image", el("fileImg").files[0]);
                if (el("fileAudio").files[0])
                    fd.append("audio", el("fileAudio").files[0]);
                if (el("fileVideo").files[0])
                    fd.append("video", el("fileVideo").files[0]);
                const id = el("blogId").value;
                let url =
                    API +
                    (id ? "/api/blog/update.php" : "/api/blog/create.php");
                if (id) fd.append("id", id);
                fetch(url, {
                    method: "POST",
                    headers: getHeaders(true),
                    body: fd
                })
                    .then(r => r.json())
                    .then(d => {
                        if (d.error) showToast(d.error, "error");
                        else {
                            showToast("Publié avec succès !");
                            blogModalInstance.hide();
                            loadBlogs();
                        }
                    });
            }
            function editBlog(b) {
                el("blogId").value = b.id;
                el("title").value = b.title;
                el("desc").value = b.description;
                el("formTitle").innerText = "Modifier";
                blogModalInstance.show();
            }
            
            function delBlog(id) {
                openConfirm('Voulez-vous vraiment Supprimer cette blog ? ', ()=>{
                    fetch(API + "/api/blog/delete.php", {
                        method: "POST",
                        headers: getHeaders(),
                        body: JSON.stringify({ id })
                    })
                    .then(data=>{
                    	showToast('blog Supprimer avec succès','success')
                    })
                    .catch(e=>showToast(e.message))
                    .then(loadBlogs);
                    })
            }
            
            function like(id) {
                fetch(API + "/api/blog/like.php", {
                    method: "POST",
                    headers: getHeaders(),
                    body: JSON.stringify({ blog_id: id })
                }).then(loadBlogs);
            }
            function addComment(bid) {
                const c = el("c_in_" + bid).value;
                if (c)
                    fetch(API + "/api/blog/comment_create.php", {
                        method: "POST",
                        headers: getHeaders(),
                        body: JSON.stringify({ blog_id: bid, content: c })
                    }).then(loadBlogs);
            }
            
            function delComment(bid, cid) {
               openConfirm('Voulez-vous Supprimer ?' ,()=>{fetch(API + "/api/blog/comment_delete.php", {
                    method: "POST",
                    headers: getHeaders(),
                    body: JSON.stringify({ blog_id: bid, comment_id: cid })
                })
                .then(data=>showToast('Commentaire Supprime !'))
                .then(loadBlogs);
               })
            }
            
            
            
            
            
            function searchFilter() {
			    // 1. Récupérer la valeur actuelle
			    const input = el('search');
			    const query = input.value.toLowerCase().trim();
			
			    // 2. Si le champ est vide, on affiche TOUT et on quitte la fonction
			    if (query === "") {
			        renderBlogs(allBlogs);
			        return;
			    }
			
			    // 3. Sinon, on filtre
			    const filtered = allBlogs.filter(b => {
			        const titleMatch = b.title?.toLowerCase().includes(query);
			        const descMatch = b.description?.toLowerCase().includes(query);
			        return titleMatch || descMatch;
			    });
			
			    // 4. On affiche les résultats filtrés
			    renderBlogs(filtered);
			}

            
            function renderBlogs(blogsToDisplay) {
		    const list = el("blogList");
		    if (!blogsToDisplay.length) {
		        list.innerHTML = `<div class="text-center text-muted mt-5">Aucun article trouvé.</div>`;
		        return;
		    }
		    
		    // Ton code .map actuel ici ...
		    list.innerHTML = blogsToDisplay.map(b => {
                                const isMine = b.user_id == currentUser.id;
                                let media = "";
                                //alert(API+'/'+b.image)
                               // alert(API+''+JSON.stringify(b.image))
                                if (b.image)
                                    media += `<img src="${API}${b.image}" loading="lazy">`;
                                if (b.video)
                                    media += `<video controls src="${API}${b.video}" class="w-100 mt-2 rounded"></video>`;
                                if (b.audio)
                                    media += `<audio controls src="${API}${b.audio}" class="w-100 mt-2"></audio>`;

                                let actions = isMine
                                    ? `
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light rounded-circle" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-h"></i></button>
                            <ul class="dropdown-menu border-0 shadow">
                                <li><a class="dropdown-item" href="#" onclick='editBlog(${JSON.stringify(
                                    b
                                ).replace(/'/g, "&#39;")})'>Modifier</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="delBlog(${
                                    b.id
                                })">Supprimer</a></li>
                            </ul>
                        </div>`
                                    : "";

                                const commentsHTML = (b.comments || [])
                                    .map(
                                        c => `
                        <div class="d-flex gap-2 mb-2">
                            <div class="bg-light p-2 rounded-3 flex-grow-1">
                                <span class="fw-bold small">${c.user_id==currentUser.id?'Moi':esc(
                                    c.username
                                )}</span> <span class="small">${esc(
                                    c.content
                                )}</span>
                            </div>
                            ${
                                c.user_id == currentUser.id ||
                                currentUser.role === "admin"
                                    ? `<button onclick="delComment(${b.id},${c.id})" class="btn btn-link text-danger p-0"><i class="fas fa-trash small"></i></button>`
                                    : ""
                            }
                        </div>`
                                    )
                                    .join("");

                                return `
                    <div class="blog-card p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex gap-2 align-items-center">
                                <div class="avatar-circle bg-primary text-white" style="font-size:0.9rem;">${
                                    b.user_id
                                }</div>
                                <div><h6 class="mb-0 fw-bold">${esc(
                                    b.title
                                )}</h6><small class="text-muted">${
                                    b.date
                                }</small></div>
                            </div>
                            ${actions}
                        </div>
                        <p class="mb-2 text-secondary">${esc(b.description)}</p>
                        ${media ? `<div class="blog-media">${media}</div>` : ""}
                        <hr class="my-2 opacity-25">
                        <div class="d-flex gap-3 mb-2">
                            <button onclick="like(${b.id})" class="btn btn-sm ${
                                b.likes > 0
                                    ? "text-danger fw-bold"
                                    : "text-muted"
                            }"><i class="${
                                b.likes > 0 ? "fas" : "far"
                            } fa-heart"></i> ${b.likes}</button>
                            <button onclick="el('c_sec_${
                                b.id
                            }').classList.toggle('d-none')" class="btn btn-sm text-muted"><i class="far fa-comment"></i> ${
                                (b.comments || []).length
                            }</button>
                        </div>
                        <div id="c_sec_${b.id}" class="d-none">
                            <div class="mb-2" style="max-height:150px;overflow-y:auto;">${commentsHTML}</div>
                            <div class="d-flex gap-2"><input id="c_in_${
                                b.id
                            }" class="form-control form-control-sm rounded-pill" placeholder="Commentaire..."><button onclick="addComment(${
                                b.id
                            })" class="btn btn-sm btn-primary-custom rounded-circle"><i class="fas fa-paper-plane"></i></button></div>
                        </div>
                    </div>`;
                            })
                            .join("");
                    
		}
            
        </script>
    </body>
</html>
