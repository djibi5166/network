<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Historique</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        :root { --primary: #4361ee; --secondary: #3f37c9; --sidebar-width: 260px; }
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; height: 100vh; overflow: hidden; }

        .wrapper { display: flex; height: 100%; width: 100%; }
        
        /* SIDEBAR NEXUS STYLE */
        .sidebar { width: var(--sidebar-width); background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; z-index: 1000; transition: all 0.3s; }
        .sidebar-header { padding: 20px 25px; color: white; font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .nav-link { padding: 12px 25px; color: #94a3b8; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-left: 3px solid transparent; text-decoration: none; cursor: pointer; }
        .nav-link:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-link.active { color: #4361ee; background: rgba(67, 97, 238, 0.1); border-left-color: #4361ee; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .topbar { height: 70px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 30px; }

        /* CARDS & TABLES */
        .stat-card { background: white; border: none; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .table-card { background: white; border-radius: 12px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow: hidden; }
        .table thead th { background: #f8f9fa; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 600; padding: 15px 25px; border: none; }
        .table tbody td { padding: 15px 25px; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        
        /* Badges Logs */
        .badge-log-del { background: #fee2e2; color: #ef4444; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .badge-log-block { background: #fef3c7; color: #d97706; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .badge-log-ok { background: #dcfce7; color: #16a34a; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }

        @media (max-width: 768px) { .sidebar { position: fixed; height: 100%; left: -100%; } .sidebar.show { left: 0; } }
        /* for dialog popup*/
        dialog {
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 5px;
            max-width: 340px;
            width: 100%;
            transition: all 0.5s ease-in-out;
        }

        /* The dark background behind the modal */
            dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px); /* Effet de flou sympa */
        }
        dialog button {
		    width: auto;       
		    height: auto;      
		    transform: scale(1);
		    font-size: 0.9rem;
		    padding: 8px 16px;
		    
     }
        .dialog-header { font-size: 0.25rem; font-weight: bold; margin-bottom: 10px; }
        .dialog-actions { display: flex; justify-content: flex-end; gap: 5px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="wrapper">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header"><i class="fas fa-cube text-primary"></i> NEXUS ADMIN</div>
        <nav class="nav flex-column mt-3">
            <a onclick="switchView('dashboard', this)" class="nav-link active"><i class="fas fa-th-large"></i> Dashboard</a>
            <a onclick="switchView('users', this)" class="nav-link"><i class="fas fa-users"></i> Utilisateurs</a>
            <a onclick="switchView('blogs', this)" class="nav-link"><i class="fas fa-layer-group"></i> Publications</a>
            <a onclick="switchView('history', this)" class="nav-link"><i class="fas fa-history"></i> Historique</a>
            <a onclick="switchView('mails', this)" class="nav-link">
               <i class="fas fa-envelope"></i> Mails
            </a>
            <a onclick="switchView('super', this)" class="nav-link">
               <i class="bi bi-person-badge-fill"></i>Super Utilisateurs
            </a>

         





        </nav>
        <div class="mt-auto p-4">
            <div class="p-3 rounded bg-dark text-center border border-secondary">
                <small class="text-muted">Admin</small>
                <div class="fw-bold text-white mb-2" id="adminName">...</div>
                <a href="index.html" class="btn btn-sm btn-primary w-100">Retour Site</a>
            </div>
            <a onclick="logout()" class="nav-link text-danger mt-2 justify-content-center"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <button id="sidebarToggle" class="btn d-md-none text-primary" onclick="document.getElementById('sidebar').classList.toggle('show')"><i class="fas fa-bars fa-lg"></i></button>
            <h5 class="mb-0 fw-bold text-dark" id="pageTitle">Dashboard</h5>
        </header>

        <div class="content-scroll">
            
            <div id="view-dashboard" class="view-section fade-in">
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="stat-card"><h6>Utilisateurs</h6><h2 id="stat-users">0</h2></div></div>
                    <div class="col-md-4"><div class="stat-card"><h6>Articles</h6><h2 id="stat-blogs">0</h2></div></div>
                    <div class="col-md-4"><div class="stat-card"><h6>J'aime Total</h6><h2 id="stat-likes">0</h2></div></div>
                </div>
                <div class="row g-4 mb-4">
                     <div class="col-lg-8"><div class="stat-card h-100"><canvas id="activityChart" style="max-height: 250px;"></canvas></div></div>
                     <div class="col-lg-4"><div class="stat-card h-100"><canvas id="roleChart" style="max-height: 250px;"></canvas></div></div>
                </div>
            </div>

            <div id="view-users" class="view-section d-none">
                <div class="stat-card mb-4">
                    <form onsubmit="event.preventDefault(); addUser();" class="row g-2">
                        <div class="col-md-4"><input id="au_user" class="form-control bg-light border-0" placeholder="Pseudo *"></div>
                        <div class="col-md-4"><input id="au_pass" type="password" class="form-control bg-light border-0" placeholder="Mot de passe *"></div>
                        <div class="col-md-4"><input id="au_email" type="email" class="form-control bg-light border-0" placeholder="Email *"></div>
                        <div class="col-md-2"><select id="au_role" class="form-select bg-light border-0"><option value="user">User</option><option value="admin">Admin</option></select></div>
                        <div class="col-md-2"><button class="btn btn-primary w-100" name="valide">Ajouter</button></div>
                    </form>
                </div>
                <div class="table-card"><div class="table-responsive"><table class="table mb-0"><thead><tr><th>User</th><th>Role</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="userTableBody"></tbody></table></div></div>
            </div>

            <div id="view-blogs" class="view-section d-none">
                <div class="table-card"><div class="table-responsive"><table class="table mb-0"><thead><tr><th>Titre</th><th>Auteur</th><th>Stats</th><th>Actions</th></tr></thead><tbody id="blogTableBody"></tbody></table></div></div>
            </div>
            
            <div id="view-super" class="view-section d-none">
               
               <form class="row row-cols-lg-auto g-3 align-items-center">
			  <div class="col-12">
			    <label class="visually-hidden" for="inlineFormInputGroupUsername">Username</label>
			    <div class="input-group">
			      <div class="input-group-text">@</div>
			      <input type="text" class="form-control" id="inlineFormInputGroupUsername" placeholder="Username">
			    </div>
			  </div>
			
			  <div class="col-12">
			    <label class="visually-hidden" for="inlineFormSelectPref">Preference</label>
			    <select class="form-select" id="inlineFormSelectPref">
			      <option selected>Choose...</option>
			      <option value="1">One</option>
			      <option value="2">Two</option>
			      <option value="3">Three</option>
			    </select>
			  </div>
			
			  <div class="col-12">
			    <div class="form-check">
			      <input class="form-check-input" type="checkbox" id="inlineFormCheck">
			      <label class="form-check-label" for="inlineFormCheck">
			        Remember me
			      </label>
			    </div>
			  </div>
			
			  <div class="col-12">
			    <button type="submit" class="btn btn-primary">Submit</button>
			  </div>
     	</form>
     	
     	
            </div>

            <div id="view-history" class="view-section d-none">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="fw-bold">Activités Récentes</h5>
                    <button onclick="loadHistory()" class="btn btn-sm btn-light"><i class="fas fa-sync-alt"></i> Actualiser</button>
                </div>
                <div class="table-card">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead><tr><th>Date</th><th>Admin</th><th>Action</th><th>Cible</th></tr></thead>
                            <tbody id="historyTableBody">
                                <tr><td colspan="4" class="text-center p-4">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
          
            <div id="view-mails" class="view-section" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-envelope me-2"></i>Gestion des Emails</h2>
        <button class="btn btn-primary btn-sm" onclick="loadEmails()">
            <i class="fas fa-sync-alt"></i> Actualiser
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Destinataire</th>
                        <th>Sujet</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="emailList">
                    </tbody>
            </table>
        </div>
    </div>
</div>

        </div>
    </main>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3"><div id="liveToast" class="toast align-items-center text-white bg-primary border-0"><div class="d-flex"><div class="toast-body" id="toastMsg"></div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div></div>

<dialog id="confirmDialog">
    <div class="dialog-header text-danger">
        <i class="fas fa-exclamation-triangle"></i> Confirmation
    </div>
    <div class="dialog-body" id="confirmMessage">
        Voulez-vous vraiment supprimer cet élément ? Cette action est irréversible.
    </div>
    <div class="dialog-actions">
        <button id="cancelBtn" class="btn btn-secondary">Annuler</button>
        <button id="confirmBtn" class="btn btn-danger">Confirmer la suppression</button>
    </div>
</dialog>


<script>
    const API = "http://localhost:8000";
    let currentUser = null, activityChartInstance = null, roleChartInstance = null;
    
        // --- GESTION DU DIALOGUE DE CONFIRMATION ---
    const confirmDialog = document.getElementById('confirmDialog');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmMessage = document.getElementById('confirmMessage');
    
    let pendingAction = null; // Stocke la fonction à exécuter

    // Fonction générique pour ouvrir le dialog
    function openConfirm(message, actionCallback) {
        confirmMessage.innerText = message || "Voulez-vous vraiment supprimer cet élément ?";
        pendingAction = actionCallback; // On sauvegarde l'action
        confirmDialog.showModal();
    }

    // Clic sur "Annuler"
    cancelBtn.addEventListener('click', () => {
        confirmDialog.close();
        pendingAction = null; // On nettoie l'action
    });

    // Clic sur "Confirmer"
    confirmBtn.addEventListener('click', () => {
        if (pendingAction) {
            pendingAction(); // Exécute la suppression
        }
        confirmDialog.close();
    });

    // Fermer si on clique en dehors (sur le backdrop)
    confirmDialog.addEventListener('click', (event) => {
        if (event.target === confirmDialog) {
            confirmDialog.close();
        }
    });

    
    const getHeaders = () => ({ 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' });
    
    //alert(JSON.stringify(getHeaders()))
    
    const esc = s => s ? String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;") : "";
    
    function showToast(m) { 
    	    const t=document.getElementById('liveToast');
    	    
    	    document.getElementById('toastMsg').innerText=m; new bootstrap.Toast(t).show(); 
    	
    }

    /* --- CHART JS INIT --- */
    function initCharts(users, blogs) {
        const admins = users.filter(u => u.role === 'admin').length;
        if(roleChartInstance) roleChartInstance.destroy();
        roleChartInstance = new Chart(document.getElementById('roleChart'), {
            type: 'doughnut',
            data: { labels: ['Admin', 'User'], datasets: [{ data: [admins, users.length-admins], backgroundColor: ['#4361ee', '#e2e8f0'] }] },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
        if(activityChartInstance) activityChartInstance.destroy();
        activityChartInstance = new Chart(document.getElementById('activityChart'), {
            type: 'bar',
            data: { labels: ['Blogs', 'Users'], datasets: [{ label: 'Total', data: [blogs.length, users.length], backgroundColor: '#4361ee', borderRadius: 5 }] },
            options: { scales: { y: { beginAtZero: true } } }
        });
    }

    /* --- DATA LOAD --- */
   async function loadStats() {
    try {
        // 1. On lance les deux requêtes en parallèle pour gagner du temps
        const [resUsers, resBlogs] = await Promise.all([
            fetch(API + '/api/admin/users.php', { headers: getHeaders() }),
            fetch(API + '/api/blog/read.php')
        ]);

        if (!resUsers.ok || !resBlogs.ok) throw new Error("Erreur lors du chargement des données");

        const users = await resUsers.json();
        const blogs = await resBlogs.json();

        // --- PARTIE UTILISATEURS ---
        document.getElementById('stat-users').innerText = users.length;
        document.getElementById('userTableBody').innerHTML = users.map(u => `
            <tr>
                <td><b>${esc(u.username)}</b></td>
                <td><span class="badge bg-light text-dark border">${u.role}</span></td>
                <td><span class="badge ${u.active !== false ? 'bg-success' : 'bg-danger'}">
                    ${u.active !== false ? 'Actif' : 'Bloqué'}
                </span></td>
                <td>${(u.id != 1 && u.id != currentUser.id) ? `
                    <button onclick="toggleUser(${u.id})" class="btn btn-sm btn-light text-warning" title="Bloquer/Débloquer"><i class="fas fa-ban"></i></button>
                    <button onclick="delUser(${u.id})" class="btn btn-sm btn-light text-danger" title="Supprimer"><i class="fas fa-trash"></i></button>`
                : '<span class="text-muted"><i class="fas fa-lock"></i></span>'}</td>
            </tr>`).join('');

        // --- PARTIE BLOGS ---
        document.getElementById('stat-blogs').innerText = blogs.length;
        document.getElementById('stat-likes').innerText = blogs.reduce((a, b) => a + (parseInt(b.likes) || 0), 0);
        
        // Mise à jour des graphiques
        initCharts(users, blogs);

        document.getElementById('blogTableBody').innerHTML = blogs.map(b => {
            // Recherche de l'auteur dans la liste des users
            const author = users.find(u => u.id == b.user_id);
            return `
                <tr>
                    <td class="text-truncate" style="max-width: 150px;" title="${esc(b.title)}">${esc(b.title)}</td>
                    <td><span class="badge bg-info-subtle text-info">${esc(author ? author.username : 'Inconnu')}</span></td>
                    <td><small><i class="fas fa-heart text-danger"></i> ${b.likes || 0}</small></td>
                    <td><button onclick="delBlog(${b.id})" class="btn btn-sm btn-light text-danger"><i class="fas fa-trash"></i></button></td>
                </tr>`;
        }).join('');

    } catch (error) {
        console.error("Erreur LoadStats:", error);
        showToast("Erreur de connexion au serveur", "danger");
    }
}

    /* --- HISTOIRE LOGIC --- */
    function loadHistory() {
        fetch(API + '/api/admin/history.php', { headers: getHeaders() }).then(r => r.json()).then(logs => {
            const tbody = document.getElementById('historyTableBody');
            if(!logs.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Aucun historique.</td></tr>'; return; }
            
            tbody.innerHTML = logs.map(l => {
                let badgeClass = 'badge-log-ok';
                if(l.action.includes('Supprimé')) badgeClass = 'badge-log-del';
                if(l.action.includes('Bloqué')) badgeClass = 'badge-log-block';

                return `
                <tr>
                    <td class="small text-muted">${l.date}</td>
                    <td class="fw-bold text-primary">${esc(l.admin)}</td>
                    <td><span class="${badgeClass}">${esc(l.action)}</span></td>
                    <td>${esc(l.target)}</td>
                </tr>`;
            }).join('');
        });
    }

    /* --- ACTIONS --- */
   // Ajouter un utilisateur
    async function addUser() { 
    const username = document.getElementById('au_user').value;
    const email = document.getElementById('au_email').value;
    const password = document.getElementById('au_pass').value;
    const role = document.getElementById('au_role').value;

    try {
        const response = await fetch(API + '/api/admin/add_user.php', {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify({ username, email, password, role })
        });
        
        let data = await response.json()
            //alert(data)
            
        if (response.ok) {
            showToast(data.status || "Utilisateur ajouté avec succès");
            // Clear inputs
            document.getElementById('au_user').value = ''; 
            document.getElementById('au_pass').value = ''; 
            document.getElementById('au_email').value = '';
            
            // REFRESH THE LIST
            await loadStats(); 
        } else {
        	 // alert(JSON.stringify(data.error))
            showToast(data.error || "Erreur lors de l'ajout",'error');
        }
        
        
    } catch (error) {
        console.error(error);
        showToast("Erreur de connexion",error);
    }
}
    
    // Bloquer / Débloquer
    async function toggleUser(id) { 
        const response = await fetch(API + '/api/admin/block_user.php', {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify({ id })
        });

        if (response.ok) {
            showToast("Statut mis à jour");
           
        }
        await loadStats(); 
    }
     // Supprimer un utilisateur
      // Supprimer un utilisateur (Modifié)
    function delUser(id) { 
        openConfirm("Voulez-vous vraiment supprimer cet utilisateur et toutes ses données ?", async () => {
            const response = await fetch(API + '/api/admin/delete_user.php', {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ id })
            });

            if (response.ok) {
                showToast("Utilisateur supprimé");
              await  loadStats(); 
            } else {
                showToast("Erreur lors de la suppression");
            }
        });
    }
    
    // Supprimer un blog
       // Supprimer un blog (Modifié)
    function delBlog(id) { 
        openConfirm("Supprimer définitivement cette publication ?", async () => {
            const response = await fetch(API + '/api/admin/delete_blog.php', {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ id })
            });

            if (response.ok) {
              await  showToast("Publication supprimée");
             await loadStats(); 
            }
        });
    }
    
    function logout() { 
    	    localStorage.removeItem('token'); 
    	    window.location.reload()
    	   
    	 }

    function switchView(v, btn) {
    // Cache toutes les sections
	    document.querySelectorAll('.view-section').forEach(e => {
	        e.classList.add('d-none');
	        e.style.display = 'none'; // Sécurité supplémentaire
	    });
	
	    // Affiche la section demandée
	    const targetView = document.getElementById('view-' + v);
	    targetView.classList.remove('d-none');
	    targetView.style.display = 'block';
	    targetView.classList.add('fade-in');
	
	    // Gère l'état actif du menu
	    document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
	    if(btn) btn.classList.add('active');
	
	    // Change le titre de la page
	    const titles = {
	        'dashboard': 'Dashboard',
	        'users': 'Utilisateurs',
	        'blogs': 'Publications',
	        'history': 'Historique',
	        'mails': 'Gestion des Emails',
	        'super': 'Super Utilisateurs'
	    };
	    document.getElementById('pageTitle').innerText = titles[v] || 'Nexus Admin';
	    
	    // Charge les données spécifiques
	    if(v === 'history') loadHistory();
	    else if(v === 'mails') loadEmails();
	    else loadStats();
}

async function loadEmails() {
		    const tbody = document.getElementById('emailList');
		    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Chargement des mails...</td></tr>';
		
		    try {
		        const response = await fetch(API + '/api/admin/get_mails.php', { headers: getHeaders() });
		        const emails = await response.json();
		
		        if(!emails.length) {
		            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-4">Aucun email envoyé pour le moment.</td></tr>';
		            return;
		        }
		
		        tbody.innerHTML = emails.reverse().map(m => `
		            <tr>
		                <td class="small text-muted">${m.date}</td>
		                <td><span class="fw-medium">${esc(m.email)}</span></td>
		                <td>${esc(m.subject)}</td>
		                <td><span class="badge bg-success-subtle text-success border border-success-subtle">Envoyé</span></td>
		                <td>
		                    <button class="btn btn-sm btn-light text-primary" onclick="showMailDetail('${esc(m.to)}')" title="Voir détails">
		                        <i class="fas fa-eye"></i>
		                    </button>
		                    
		                    <button class="btn btn-sm btn-light text-danger" onclick="rmEmail('${m.id}')" title="remove">
		                        <i class="fas fa-trash"></i>
		                    </button>
		                    
		                </td>
		            </tr>
		        `).join('');
		    } catch (error) {
		        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger p-4">Erreur lors du chargement des logs.</td></tr>';
		    }
}   
     // to remov Email 
      // Supprimer un Email (Modifié)
    function rmEmail(id) {
        openConfirm("Supprimer ce log d'email de l'historique ?", () => {
            fetch(API + '/api/admin/delete_email.php', {
                method: 'POST',
                headers: getHeaders(), 
                body: JSON.stringify({ id })
            })
            .then(r => r.json())
            .then(data => {
                showToast(data.message || "Email supprimé"); // Adaptation possible selon votre API
               
            })
            .then(loadEmails())
            .catch(e => {
                console.error("Erreur:", e);
                showToast("Erreur lors de la suppression");
            });
        });
    }


    /* --- INIT --- */
    (function init() {
        const t = localStorage.getItem('token');
        if(!t) return window.location.href=API+'/frontend/index.html';
        try {
            function parseJwt(tk){let b=tk.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');const p=b.length%4;if(p)b+=new Array(5-p).join('=');return JSON.parse(decodeURIComponent(window.atob(b).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join('')));}
            const p = parseJwt(t);
            if(p.role!=='admin') throw new Error('Not Admin');
            currentUser = p;
            document.getElementById('adminName').innerText = p.username;
            loadStats();
        } catch(e) {
        	localStorage.removeItem('token');
        	location.href=API+'/frontend/'; }
    })();

    // Close sidebar on click outside logic
    document.addEventListener('click', e => {
        const s = document.getElementById('sidebar'), b = document.getElementById('sidebarToggle');
        if(s && b && s.classList.contains('show') && !s.contains(e.target) && !b.contains(e.target)) s.classList.remove('show');
    });
    
    
    function checkAuth() {
                const token = localStorage.getItem("token");
                if (!token) return showAuth();

                const payload = parseJwt(token);
                if (!payload || payload.exp * 500 < Date.now()) {
                    logout();
                    return;
                }
               
                currentUser = payload;
                showApp();
                verifyTokenWithServer();
            }
            
     function showAuth() {
                el("authView").classList.remove("d-none");
                el("appView").classList.add("d-none");
            }
            
     function verifyTokenWithServer() {
			    fetch(API + "/api/auth/me.php", {
			        method: "GET",
			        headers: getHeaders()
			    })
			    .then(res => {
			        if (res.status === 401) {
			            // C'est ici que ton bloc 401 est utile !
			            logout();
			            showToast("Session invalide ", "error");
			        }
			    })
			    .catch(err => console.error("Erreur réseau:", err));
			}
			
	document.addEventListener('DOMContentLoaded',()=>{
		
		checkAuth()
	})

</script>
<style>.fade-in{animation:fadeIn 0.4s ease-in-out}@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}</style>
</body>
</html>
